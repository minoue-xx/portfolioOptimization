<!--
    https://www.aspsnippets.com/Articles/Read-CSV-File-in-jQuery-using-HTML5-File-API.aspx
-->
<!--row.append($("<td/>").text(cells[colIndex]));-->

<head>
    <title>getting quotes</title>

<body>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript">
        $(function () {
            $("#upload").bind("click", function () {
                var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
                if (regex.test($("#fileUpload").val().toLowerCase())) {
                    if (typeof (FileReader) != "undefined") {
                        var reader = new FileReader();
                        reader.onload = function (e) {

                            var rowdata = e.target.result.split("\n");

                            container = $("#dvCSV");
                            container.html('');
                            makeTable(container, rowdata);
                            updateQuotes();
                            updateQuotes_updates();

                        }
                        reader.readAsText($("#fileUpload")[0].files[0]);
                    } else {
                        alert("This browser does not support HTML5.");
                    }
                } else {
                    alert("Please upload a valid CSV file.");
                }
            });
        });

        function makeTable(container, rowdata) {

            rowdata = rowdata.filter(word => word.length > 1);
            var table = $("<table/>");
            table.attr('id', 'tblTickers');
            var thead = $("<thead/>");
            var row = $("<tr/>");
            row.append($("<td/>").text("Ticker"));
            row.append($("<td/>").text("Quantity"));
            row.append($("<td/>").text("Price"));
            row.append($("<td/>").text("Sub-Total"));
            row.append($("<td/>").text("actual"));
            row.append($("<td/>").text("target"));
            thead.append(row);
            table.append(thead);

            var tbody = $("<tbody/>");
            $.each(rowdata, function (rowIndex, r) {
                var row = $("<tr/>");
                var cells = rowdata[rowIndex].split(",");

                cells = cells.filter(word => word.length > 1);
                $.each(cells, function (colIndex) {
                    var col = $("<td/>");
                    var input = $("<input/>");
                    input.attr('type', 'text');
                    input.attr('value', cells[colIndex]);
                    if (colIndex == 0) {
                        input.attr('class', 'ticker');
                        input.attr('name', 'ticker');
                    }
                    if (colIndex == 1) {
                        input.attr('class', 'qty');
                        input.attr('name', 'qty');
                    }
                    col.append(input);
                    row.append(col);
                });
                for (var i = 0; i <= 3; i++) {
                    var col = $("<td/>");
                    var input = $("<input/>");
                    input.attr('type', 'text');
                    input.attr('value', "");
                    if (i == 0) {
                        input.attr('class', 'price');
                        input.attr('name', 'price');
                    }
                    if (i == 1) {
                        input.attr('class', 'subtot');
                        input.attr('name', 'subtot');
                    }
                    col.append(input);
                    row.append(col);
                }
                tbody.append(row);
            });
            table.append(tbody);


            var tfoot = $("<tfoot/>");
            var row = $("<tr/>");
            for (var i = 0; i <= 2; i++) {
                row.append($("<td/>").text(""));
            }
            for (var i = 0; i <= 2; i++) {
                var col = $("<td/>");
                var input = $("<input/>");
                input.attr('type', 'text');
                input.attr('value', '');
                col.append(input);
                row.append(col);
            }
            tfoot.append(row);
            table.append(tfoot);

            return container.append(table);
        }


        function updateQuotes_updates($tblrows) {
            var $tblrows = $("#tblTickers tbody tr");
            $tblrows.each(function (index) {
                var $tblrow = $(this);

                $tblrow.find('.ticker').on('change', function () {

                    var qty = $tblrow.find("[name=qty]").val();
                    var price = $tblrow.find("[name=price]").val();
                    var subTotal = parseInt(qty, 10) * parseFloat(price);

                    var ticker = $tblrow.find("[name=ticker]").val();
                    var qty = $tblrow.find("[name=qty]").val();

                    var url = "https://financialmodelingprep.com/api/v3/stock/real-time-price/" + ticker;

                    $.getJSON(url, function (data) {

                        var price = data.price;
                        console.log(price.toString());
                        $tblrow.find('.price').val(price.toFixed(2));

                        var subTotal = parseInt(qty, 10) * parseFloat(price);

                        if (!isNaN(subTotal)) {

                            $tblrow.find('.subtot').val(subTotal.toFixed(2));

                            var grandTotal = 0;
                            $(".subtot").each(function () {
                                var stval = parseFloat($(this).val());
                                grandTotal += isNaN(stval) ? 0 : stval;
                            });

                        }
                    });
                });
            });
        }

        function updateQuotes($tblrows) {
            $('.price, .subtot, .grdtot').prop('readonly', true);
            var $tblrows = $("#tblTickers tbody tr");

            $tblrows.each(function (index) {
                var $tblrow = $(this);

                var ticker = $tblrow.find("[name=ticker]").val();
                var qty = $tblrow.find("[name=qty]").val();

                var url = "https://financialmodelingprep.com/api/v3/stock/real-time-price/" + ticker;

                $.getJSON(url, function (data) {

                    var price = data.price;
                    console.log(price.toString());
                    $tblrow.find('.price').val(price.toFixed(2));

                    var subTotal = parseInt(qty, 10) * parseFloat(price);

                    if (!isNaN(subTotal)) {

                        $tblrow.find('.subtot').val(subTotal.toFixed(2));

                        var grandTotal = 0;
                        $(".subtot").each(function () {
                            var stval = parseFloat($(this).val());
                            grandTotal += isNaN(stval) ? 0 : stval;
                        });

                    }
                });
            });
        }

        function appendTableColumn(table, rowData) {
            var lastRow = $('<tr/>').appendTo(table.find('tbody:last'));
            $.each(rowData, function (colIndex, c) {
                lastRow.append($('<td/>').text(c));
            });

            return lastRow;
        }

    </script>

    <input type="file" id="fileUpload" />
    <input type="button" id="upload" value="Upload" />
    <hr />
    <div id="dvCSV">
    </div>
</body>
</head>

<!-- 
$(function () { var $tblrows=$("#tblTickers tbody tr"); $tblrows.each(function (index) { var $tblrow=$(this);
    $tblrow.find('.ticker').on('change', function () { var ticker=$tblrow.find("[name=ticker]").val(); var
    callback=function (data) { var price=data.price; $tblrow.find("[name=price]").val()=price; }; var
    url="https://financialmodelingprep.com/api/v3/stock/real-time-price/" + ticker; var data="" ; $.getJSON(url, data,
    callback); var qty=$tblrow.find("[name=qty]").val(); var subTotal=parseInt(qty, 10) * parseFloat(price); if
    (!isNaN(subTotal)) { $tblrow.find('.subtot').val(subTotal.toFixed(2)); $(".subtot").each(function () { var
    stval=parseFloat($(this).val()); grandTotal +=isNaN(stval) ? 0 : stval; }); } }); }); }); 
-->

<!--
    <p id="pCSV">
        <table id="tblTickers">
            <thead>
                <tr>
                    <td>Ticker</td>
                    <td>Quantity</td>
                    <td>Price</td>
                    <td>Sub-Total</td>
                    <td>actual</td>
                    <td>target</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" class="ticker" value="" name="pnm" /></td>
                    <td><input type="text" class="qty" value="" name="qty" /></td>
                    <td><input type="text" class="price" value="0" name="price" /></td>
                    <td><input type="text" class="subtot" value="0" name="subtot" /></td>
                    <td><input type="text" class="actual" value="0" name="actual" /></td>
                    <td><input type="text" class="target" value="0" name="target" /></td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><input type="text" class="grdtot" value="" name="" /></td>
                </tr>
            </tfoot>
        </table>
    </p>
-->


<!--
    var html = '<table  class="table table-condensed table-hover table-striped">';
 
      if(typeof(data[0]) === 'undefined') {
        return null;
      } else {
		$.each(data, function( index, row ) {
		  //bind header
		  if(index == 0) {
			html += '<thead>';
			html += '<tr>';
			$.each(row, function( index, colData ) {
				html += '<th>';
				html += colData;
				html += '</th>';
			});
			html += '</tr>';
			html += '</thead>';
			html += '<tbody>';
		  } else {
			html += '<tr>';
			$.each(row, function( index, colData ) {
				html += '<td>';
				html += colData;
				html += '</td>';
			});
			html += '</tr>';
		  }
		});
		html += '</tbody>';
		html += '</table>';
		alert(html);
		$('#csv-display').append(html);
	  }
-->